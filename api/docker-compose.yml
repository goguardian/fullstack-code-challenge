version: '3'

services:
  go-grpc:
    image: 476415093293.dkr.ecr.us-west-2.amazonaws.com/goguardian/golang_build_v2
    ports:
      - 8889:8889/tcp # gRPC
      - 8890:8890/tcp # HTTP (HC)
    environment:
      - AWS_ACCESS_KEY_ID=AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY=AWS_SECRET_ACCESS_KEY
      - DISABLE_VAULT=1
      - ENVIRONMENT=docker-compose
      - GO_CORE_API_API_TOKEN=GO_CORE_API_API_TOKEN
      - GO_CORE_API_CACHE_TTL=10s
      - LOG_LEVEL=debug
      - REDIS_HOST_ADDRESS=redis:6379
      - SRS_ETCD_ADDRESS=etcd:2379
    depends_on:
      - etcd
      - go-core-api
      - redis
    links:
      - etcd
      - go-core-api
      - redis
    volumes:
      - /liminex/go.mod:/liminex/go.mod
      - /liminex/go.sum:/liminex/go.sum
      - /liminex/golang/proto:/liminex/golang/proto:cached
      - /liminex/golang/ggg:/liminex/golang/ggg:cached
      - /liminex/golang/proto:/liminex/golang/proto:cached
      - /liminex/services/examples/go-grpc:/liminex/services/examples/go-grpc:consistent
    working_dir: /liminex/services/examples/go-grpc
    # Use during active development
    command: bash -c "go get github.com/pilu/fresh && /liminex/golang/bin/fresh -c ./fresh.conf"
    # Use otherwise
    # command: bash -c "go build -mod=readonly && ./go-grpc"

  go-core-api:
    image: 476415093293.dkr.ecr.us-west-2.amazonaws.com/goguardian/golang_build_v2
    links:
      - etcd
      - mysql-liminex-ent
    depends_on:
      - etcd
      - mysql-liminex-ent
    environment:
      - ACCOUNTS_UPDATE_SNS_TOPIC_ARN=ACCOUNTS_UPDATE_SNS_TOPIC_ARN
      - ADMIN_UPDATE_SNS_TOPIC_ARN=ADMIN_UPDATE_SNS_TOPIC_ARN
      - AUTH_S3_BUCKET=AUTH_S3_BUCKET
      - AUTH_S3_REGION=AUTH_S3_REGION
      - AUTH_ENVIRONMENT=dev
      - DB_READ_DSN=root:MYSQL_ROOT_PASSWORD@tcp(mysql-liminex-ent:3306)/MYSQL_DATABASE?parseTime=true
      - DB_WRITE_DSN=root:MYSQL_ROOT_PASSWORD@tcp(mysql-liminex-ent:3306)/MYSQL_DATABASE?parseTime=true
      - ENVIRONMENT=docker-compose
      - LOG_LEVEL=debug
      - SRS_ETCD_ADDRESS=etcd:2379
    volumes:
      - ~/.aws:/root/.aws:cached
      - /liminex/golang/ggg:/liminex/golang/ggg:cached
      - /liminex/golang/proto:/liminex/golang/proto:cached
      - /liminex/beacon/notifier/shared:/liminex/beacon/notifier/shared:cached
      - /liminex/services/go-core-api:/liminex/services/go-core-api:delegated
    working_dir: /liminex/services/go-core-api
    # Use during active development
    # command: bash -c "go get github.com/pilu/fresh && /liminex/golang/bin/fresh -c ./fresh.conf"
    # Use otherwise
    command: bash -c "go build && ./go-core-api"

  mysql-liminex-ent:
    image: mysql:5.7
    ports:
      - 3309:3306
    environment:
      - MYSQL_DATABASE=MYSQL_DATABASE
      - MYSQL_ROOT_PASSWORD=MYSQL_ROOT_PASSWORD
    command: mysqld --sql_mode=""

  mysql-liminex-ent-migrations:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - NPM_TOKEN
      - LIMINEX_ENT_MYSQL_HOSTNAME=mysql-liminex-ent
      - LIMINEX_ENT_MYSQL_PORT=3306
      - LIMINEX_ENT_MYSQL_USERNAME=root
      - LIMINEX_ENT_MYSQL_PASSWORD=MYSQL_ROOT_PASSWORD
      - LIMINEX_ENT_MYSQL_DATABASE=MYSQL_DATABASE
    depends_on:
      - mysql-liminex-ent
    links:
      - mysql-liminex-ent
    volumes:
      - ~/.aws:/root/.aws:cached
      - /liminex/core-platform/migrations:/liminex/core-platform/migrations:delegated
    working_dir: /liminex/core-platform/migrations
    command: bash -c "npm i && ./node_modules/knex/bin/cli.js migrate:latest --env development --knexfile ./liminex-ent/knexfile.js"

  mysql-liminex-ent-seeds:
    build:
      context: .
      dockerfile: Dockerfile.node
    environment:
      - NPM_TOKEN
      - LIMINEX_ENT_MYSQL_HOSTNAME=mysql-liminex-ent
      - LIMINEX_ENT_MYSQL_PORT=3306
      - LIMINEX_ENT_MYSQL_USERNAME=root
      - LIMINEX_ENT_MYSQL_PASSWORD=MYSQL_ROOT_PASSWORD
      - LIMINEX_ENT_MYSQL_DATABASE=MYSQL_DATABASE
    depends_on:
      - mysql-liminex-ent
      - mysql-liminex-ent-migrations
    links:
      - mysql-liminex-ent
      - mysql-liminex-ent-migrations
    volumes:
      - /liminex/core-platform/migrations:/liminex/core-platform/migrations:delegated
    working_dir: /liminex/core-platform/migrations
    command: bash -c "npm i && ./node_modules/knex/bin/cli.js seed:run --knexfile ./liminex-ent/knexfile.js"

  etcd:
    image: appcelerator/etcd
    volumes:
      - etcd-data:/data

  redis:
    image: redis
    ports:
      - 6379:6379/tcp

volumes:
  etcd-data:
